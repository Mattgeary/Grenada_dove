setwd(paste(getwd(), "Figs", sep = "/"))
library(GISTools)
ppi <- 300


### Scalebar function
scalebar<-function(dim,coord=NA,padding=c(5,5),labels=paste(dim),...){
  #defaults to a lower left hand position
  padding<-padding/100
  parrange<-c(par()$usr[2]-par()$usr[1],par()$usr[4]-par()$usr[3])
  if(is.na(coord)) coord<-c(par()$usr[1]+(padding[1]*parrange[1]),par()$usr[3]+(padding[2]*parrange[2]))
  lines(matrix(c(coord[1],coord[2],coord[1]+dim,coord[2]),byrow=T,nrow=2),...)
  text(coord[1]+(0.5*dim),coord[2],labels=labels,adj=c(0.5,-0.25),...)
}

### Future climate stack 2050
climate.2050 <- stack(pred.sp, climate.fun(forest.mod, future.ppt.dry.month.50[[1]]), climate.fun(forest.mod, future.ppt.dry.month.50[[2]]), climate.fun(forest.mod, future.ppt.dry.month.50[[3]]), climate.fun(forest.mod, future.ppt.dry.month.50[[4]]))
names(climate.2050) <- c("Current", "rcp26 - 2050", "rcp45 - 2050", "rcp60 - 2050", "rcp85 - 2050")
save(climate.2050, file = "Climate_2050.RData")

png("Climate_2050.png", width = 12*ppi, height = 12*ppi, res = ppi)
par(cex = 2, mar = c(6,6,0.5,5))
plot(climate.2050)
dev.off()


### Future climate stack 2070
climate.2070 <- stack(pred.sp, climate.fun(forest.mod, future.ppt.dry.month.70[[1]]), climate.fun(forest.mod, future.ppt.dry.month.70[[2]]), climate.fun(forest.mod, future.ppt.dry.month.70[[3]]), climate.fun(forest.mod, future.ppt.dry.month.70[[4]]))
names(climate.2070) <- c("Current", "rcp26 - 2070", "rcp45 - 2070", "rcp60 - 2070", "rcp85 - 2070")
save(climate.2070, file = "Climate_2070.RData")

png("Climate_2070.png", width = 12*ppi, height = 12*ppi, res = ppi)
par(cex = 2, mar = c(6,6,0.5,5))
plot(climate.2070)
dev.off()

## Curent vs future 2050
png("rcp45_2050.png", width = 12*ppi, height = 12*ppi, res = ppi)
par(mfrow = c(2,2), cex = 2, mar = c(6,6,0.5,5))
plot(pred.sp, main = "Current predicted suitability")
points(forest.env[,2], forest.env[,1], pch = 16,  col = (forest.env$pres+2)*2, cex =2)
points(test.env[,2], test.env[,1], pch = 16,  col = (test.env$pres+2)*2, cex =2)
scalebar(0.045, padding = c(2, 80), labels = "5 km", cex = 2)
north.arrow(-61.777, 12.205, 0.005)
plot(climate.fun(forest.mod, future.ppt.dry.month.50[[2]]), main = "Predicted suitability under rcp45 - 2050")
points(forest.env[,2], forest.env[,1], pch = 16,  col = (forest.env$pres+2)*2, cex =2)
points(test.env[,2], test.env[,1], pch = 16,  col = (test.env$pres+2)*2, cex =2)
scalebar(0.045, padding = c(2, 80), labels = "5 km", cex = 2)
north.arrow(-61.777, 12.205, 0.005)
thresh.rcl <- matrix(c(-1, 0.66, 0, 0.66, 1.5, 1), nrow=2, ncol=3, byrow=TRUE)
plot(reclassify(pred.sp, thresh.rcl), main = "Current predicted presence/absence")
points(forest.env[,2], forest.env[,1], pch = 16,  col = (forest.env$pres+2)*2, cex =2)
points(test.env[,2], test.env[,1], pch = 16,  col = (test.env$pres+2)*2, cex =2)
scalebar(0.045, padding = c(2, 80), labels = "5 km", cex = 2)
north.arrow(-61.777, 12.205, 0.005)
plot(reclassify(climate.fun(forest.mod, future.ppt.dry.month.50[[2]]), thresh.rcl), main = "Predicted presence/absence under rcp45 - 2050")
points(forest.env[,2], forest.env[,1], pch = 16,  col = (forest.env$pres+2)*2, cex =2)
points(test.env[,2], test.env[,1], pch = 16,  col = (test.env$pres+2)*2, cex =2)
scalebar(0.045, padding = c(2, 80), labels = "5 km", cex = 2)
north.arrow(-61.777, 12.205, 0.005)
par(mfrow = c(1,1))
dev.off()

## Curent vs future 2070
png("rcp45_2070.png", width = 12*ppi, height = 12*ppi, res = ppi)
par(mfrow = c(2,2), cex = 2, mar = c(6,6,0.5,5))
plot(pred.sp, main = "Current predicted suitability")
scalebar(0.045, labels = "5 km")
north.arrow(-61.895, 12.03, 0.01)
plot(climate.fun(forest.mod, future.ppt.dry.month.70[[2]]), main = "Predicted suitability under rcp45 - 2070")
scalebar(0.045, labels = "5 km")
north.arrow(-61.895, 12.03, 0.01)
thresh.rcl <- matrix(c(-1, 0.66, 0, 0.66, 1.5, 1), nrow=2, ncol=3, byrow=TRUE)
plot(reclassify(pred.sp, thresh.rcl), main = "Current predicted presence/absence")
scalebar(0.045, labels = "5 km")
north.arrow(-61.895, 12.03, 0.01)
plot(reclassify(climate.fun(forest.mod, future.ppt.dry.month.70[[2]]), thresh.rcl), main = "Predicted presence/absence under rcp45 - 2070")
scalebar(0.045, labels = "5 km")
north.arrow(-61.895, 12.03, 0.01)
par(mfrow = c(1,1))
dev.off()

png("Current prediction.png", width = 12*ppi, height = 12*ppi, res = ppi)
par(cex = 2, mar = c(6,6,0.5,5))
plot(pred.sp)
points(forest.env[,2], forest.env[,1], pch = 16,  col = (forest.env$pres+2)*2, cex =2)
points(test.env[,2], test.env[,1], pch = 16,  col = (test.env$pres+2)*2, cex =2)
scalebar(0.045, padding = c(2, 80), labels = "5 km", cex = 2)
north.arrow(-61.777, 12.205, 0.005)
par(cex = 1, mar = c(5,4,4,2) + 0.1)
dev.off()

png("rcp45_2050.png", width = 12*ppi, height = 12*ppi, res = ppi)
par(cex = 2, mar = c(6,6,0.5,5))
plot(climate.fun(forest.mod, future.ppt.dry.month.50[[2]]))
points(forest.env[,2], forest.env[,1], pch = 16,  col = (forest.env$pres+2)*2, cex =2)
points(test.env[,2], test.env[,1], pch = 16,  col = (test.env$pres+2)*2, cex =2)
scalebar(0.045, padding = c(2, 80), labels = "5 km", cex = 2)
north.arrow(-61.777, 12.205, 0.005)
dev.off()

png("rcp45_2070.png", width = 12*ppi, height = 12*ppi, res = ppi)
par(cex = 2, mar = c(6,6,0.5,5))
plot(climate.fun(forest.mod, future.ppt.dry.month.70[[2]]))
points(forest.env[,2], forest.env[,1], pch = 16,  col = (forest.env$pres+2)*2, cex =2)
points(test.env[,2], test.env[,1], pch = 16,  col = (test.env$pres+2)*2, cex =2)
scalebar(0.045, padding = c(2, 80), labels = "5 km", cex = 2)
north.arrow(-61.777, 12.205, 0.005)
dev.off()

png("Current pa.png", width = 12*ppi, height = 12*ppi, res = ppi)
par(cex = 2, mar = c(6,6,0.5,5))
#tiff("Current_pa.tiff", res=600, compression = "lzw", height=5, width=5, units="in")
thresh.rcl <- matrix(c(-1, 0.66, 0, 0.66, 1.5, 1), nrow=2, ncol=3, byrow=TRUE)
plot(reclassify(pred.sp, thresh.rcl))
plot(GRD, add= TRUE)
points(forest.env[,2], forest.env[,1], pch = 16,  col = (forest.env$pres+2)*2, cex =2)
points(test.env[,2], test.env[,1], pch = 16,  col = (test.env$pres+2)*2, cex =2)
scalebar(0.045, padding = c(2, 80), labels = "5 km", cex = 2)
north.arrow(-61.777, 12.205, 0.005)
dev.off()

png("PresAbs_rcp45_2050.png", width = 12*ppi, height = 12*ppi, res = ppi)
par(cex = 2, mar = c(6,6,0.5,5))
thresh.rcl <- matrix(c(-1, 0.66, 0, 0.66, 1.5, 1), nrow=2, ncol=3, byrow=TRUE)
plot(reclassify(climate.fun(forest.mod, future.ppt.dry.month.50[[2]]), thresh.rcl))
plot(GRD, add = TRUE)
points(forest.env[,2], forest.env[,1], pch = 16,  col = (forest.env$pres+2)*2, cex =2)
points(test.env[,2], test.env[,1], pch = 16,  col = (test.env$pres+2)*2, cex =2)
scalebar(0.045, padding = c(2, 80), labels = "5 km", cex = 2)
north.arrow(-61.777, 12.205, 0.005)
dev.off()

png("PresAbs_rcp45_2070.png", width = 12*ppi, height = 12*ppi, res = ppi)
par(cex = 2, mar = c(6,6,0.5,5))
thresh.rcl <- matrix(c(-1, 0.66, 0, 0.66, 1.5, 1), nrow=2, ncol=3, byrow=TRUE)
plot(reclassify(climate.fun(forest.mod, future.ppt.dry.month.70[[2]]), thresh.rcl))
plot(GRD, add = TRUE)
points(forest.env[,2], forest.env[,1], pch = 16,  col = (forest.env$pres+2)*2, cex =2)
points(test.env[,2], test.env[,1], pch = 16,  col = (test.env$pres+2)*2, cex =2)
scalebar(0.045, padding = c(2, 80), labels = "5 km", cex = 2)
north.arrow(-61.777, 12.205, 0.005)
dev.off()

png("Hurricane_examples.png", width = 12*ppi, height = 12*ppi, res = ppi)
par(cex = 2, mar = c(6,6,0.5,5))
par(mfrow = c(2,2))
plot(pred.sp - hurricane(alt))
plot(pred.sp - hurricane(alt))
plot(pred.sp - hurricane(alt))
plot(pred.sp - hurricane(alt))
dev.off()

box.labels <- c("Hurricanes", "Sea leval\n& Land use", "Hurricanes\n& Land use", "Sea level,\nLand use\n& Hurricanes", "Sea level\n& Hurricanes", "All rcp26", "All rcp45", "All rcp60", "All rcp85")

png("Scenarios_results_2050.png", width = 12*ppi, height = 12*ppi, res = ppi)
par(mar = c(10, 5, 2,2), cex = 2)
boxplot(f.50$all[,1:9], ylab = "Percentage area predicted present", las = 2, names = box.labels, main = "2050")
abline(f.50[[1]][3], 0, col = "red")
par(mar = c(5,4,4,2) + 0.1)
dev.off()


png("Scenarios_results_2070.png", width = 12*ppi, height = 12*ppi, res = ppi)
par(mar = c(10, 5, 2,2) , cex = 2)
boxplot(f.70$all[,1:9], ylab = "Percentage area predicted present", las = 2, names = box.labels, main = "2070")
abline(f.50[[1]][3], 0, col = "red")
par(mar = c(5,4,4,2) + 0.1)
dev.off()

png("Scenarios_climate_results_2050.png", width = 12*ppi, height = 12*ppi, res = ppi)
par(mar = c(6, 5, 2,2) , cex = 2)
boxplot(f.50$all[,6:9], ylab = "Percentage area predicted present", las = 2, names = box.labels[6:9], main = "2050")
abline(f.50[[1]][3], 0, col = "red")
par(mar = c(5,4,4,2) + 0.1)
dev.off()

png("Scenarios_climate_results_2070.png", width = 12*ppi, height = 12*ppi, res = ppi)
par(mar = c(6, 5, 2,2), cex = 2)
boxplot(f.70$all[,6:9], ylab = "Percentage area predicted present", las = 2, names = box.labels[6:9], main = "2070")
abline(f.50[[1]][3], 0, col = "red")
par(mar = c(5,4,4,2) + 0.1)
dev.off()

png("Hurricane_climate_results_2050.png", width = 12*ppi, height = 12*ppi, res = ppi)
par(mar = c(5, 5, 2,2), cex = 2)
boxplot(f.50$all[,10:13], ylab = "Percentage area predicted present", las = 2, names = c("rcp26", "rcp45", "rcp60", "rcp80"), main = "2050")
abline(f.50[[1]][3], 0, col = "red")
par(mar = c(5,4,4,2) + 0.1)
dev.off()

png("Hurricane_climate_results_2070.png", width = 12*ppi, height = 12*ppi, res = ppi)
par(mar = c(5, 5, 2,2), cex = 2)
boxplot(f.70$all[,10:13], ylab = "Percentage area predicted present", las = 2, names = c("rcp26", "rcp45", "rcp60", "rcp80"), main = "2070")
abline(f.50[[1]][3], 0, col = "red")
par(mar = c(5,4,4,2) + 0.1)
dev.off()

lum <- reclassify(land.use.mask, cbind(0, NA))

png("Land_use_mask.png", width = 12*ppi, height = 12*ppi, res = ppi)
par(cex = 2, mar = c(6,6,0.5,5))
plot(pred.sp)
plot(lum, alpha = 0.7, add = TRUE, legend = FALSE, col= rev(gray.colors(n =2)))
points(forest.env[,2], forest.env[,1], pch = 16,  col = (forest.env$pres+2)*2, cex =2)
points(test.env[,2], test.env[,1], pch = 16,  col = (test.env$pres+2)*2, cex =2)
scalebar(0.045, padding = c(2, 80), labels = "5 km", cex = 2)
north.arrow(-61.777, 12.205, 0.005)
dev.off()

png("Land_use_mask_2050.png", width = 12*ppi, height = 12*ppi, res = ppi)
par(cex = 2, mar = c(6,6,0.5,5))
plot(climate.fun(forest.mod, future.ppt.dry.month.50[[2]]))
plot(lum, alpha = 0.7,  add = TRUE, legend = FALSE, col= rev(gray.colors(n =2)))
points(forest.env[,2], forest.env[,1], pch = 16,  col = (forest.env$pres+2)*2, cex =2)
points(test.env[,2], test.env[,1], pch = 16,  col = (test.env$pres+2)*2, cex =2)
scalebar(0.045, padding = c(2, 80), labels = "5 km", cex = 2)
north.arrow(-61.777, 12.205, 0.005)
dev.off()

png("Land_use_mask_2070.png", width = 12*ppi, height = 12*ppi, res = ppi)
par(cex = 2, mar = c(6,6,0.5,5))
plot(climate.fun(forest.mod, future.ppt.dry.month.70[[2]]))
plot(lum, alpha = 0.7, add = TRUE, legend = FALSE, col= rev(gray.colors(n =2)))
points(forest.env[,2], forest.env[,1], pch = 16,  col = (forest.env$pres+2)*2, cex =2)
points(test.env[,2], test.env[,1], pch = 16,  col = (test.env$pres+2)*2, cex =2)
scalebar(0.045, padding = c(2, 80), labels = "5 km", cex = 2)
north.arrow(-61.777, 12.205, 0.005)
dev.off()